# Setting up [anvil](https://github.com/foundry-rs/foundry) as an L1

## Prerequisites

You will need:
* `zkstack` matching latest protocol version supported by anvil-zksync
  * To install: take a look at the root workspace `Cargo.toml` which should contain `zksync_contracts = "=<version>-non-semver-compat"`. Now clone [zksync-era](https://github.com/matter-labs/zksync-era) and checkout tag `core-v<version>`. Install zkstackup if you have not done so already and then run `zkstackup --local`. Confirm that build timestamp is recent when you run `zkstack --version`.
* A local postgres instance as expected by `zkstack`
  * To initialize a fresh one just run `zkstack dev clean all && zkstack containers -o false` in the `zksync-era` root directory. We do not actually need the database but zkstack will fail on one of the steps as it expects it to exist.
  * NOTE: `zkstack` will also spin up a `reth` instance that occupies port 8545 which we need. Please stop it before proceeding by running `docker stop zksync-era-reth-1`.
* `yq` for YAML config manipulation. Follow https://github.com/mikefarah/yq to install.

## Generate state file

⚠️ Note: The rest of the section assumes your current working directory is `l1-setup`.

The entire process is contained inside a single bash script that you can invoke (protocol version is optional, latest supported will be used by default):

```bash
$ ./setup.sh [protocol_version]
```

For example, to generate L1 setup data for both v26 and v27:

```bash
$ ./setup.sh v26 && ./setup.sh v27
```

After using the script with non-latest protocol version, `contracts` submodule might have a git diff. Ignore that and do not commit it.

Note: Re-running this flow with the same input parameters will result in different contract configuration and L1 state. This is expected as `create2_factory_salt` is random each time.

## File structure overview
* `./configs` contains L1/L2 chain configurations that were generated by the script above
  - `<protocol_version>-genesis.yaml` - header information about genesis as expected by L1
  - `<protocol_version>-contracts.yaml` - L1 contracts' addresses and L2 contracts' addresses to be deployed by upgrade transaction
* `./state` contains L1/L2 state artifacts that were generated by the script above
  - `<protocol_version>-l1-state.json` - uncompressed `anvil` state that can be used to quickly spin up a new clean L1 instance (TODO: IMHO can be deleted, it's the heaviest file out of the bunch by far and is entirely replaceable by payload now).
  - `<protocol_version>-l1-state-payload.txt` - compressed `anvil` state in the form of `anvil_loadState` payload
  - `<protocol_version>-l2-upgrade-tx.json` - L2 upgrade transaction as expected by L1; needs to be executed before any other transaction
* `./patches` contains static files (i.e. these do not change under normal circumstances) that patch zkstack's default config
  - `<protocol_version>-genesis-patch.yaml` - patch containing custom AA/bootloader hash, which in turn affects root hash and commitment that are also included in the patch
